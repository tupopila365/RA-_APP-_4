version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: roads-authority-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-roads-authority}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - roads-authority-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: roads-authority-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_DOCKER_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    networks:
      - roads-authority-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: roads-authority-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      MONGODB_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME:-admin}:${MONGO_INITDB_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGO_INITDB_DATABASE:-roads-authority}?authSource=admin
      REDIS_URL: redis://:${REDIS_DOCKER_PASSWORD:-redis123}@redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_ACCESS_EXPIRY: ${JWT_ACCESS_EXPIRY:-15m}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-7d}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      RAG_SERVICE_URL: http://rag-service:8000
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173,http://localhost:19006}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - ./backend/src:/app/src
      - ./backend/uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - roads-authority-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Admin Dashboard
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: roads-authority-admin
    restart: unless-stopped
    ports:
      - "${ADMIN_PORT:-5173}:5173"
    environment:
      VITE_API_BASE_URL: http://localhost:${BACKEND_PORT:-3000}
    volumes:
      - ./admin/src:/app/src
    depends_on:
      - backend
    networks:
      - roads-authority-network

  # RAG Service
  rag-service:
    build:
      context: ./rag-service
      dockerfile: Dockerfile
    container_name: roads-authority-rag-service
    restart: unless-stopped
    ports:
      - "${RAG_SERVICE_PORT:-8000}:8000"
    environment:
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text:latest}
      OLLAMA_LLM_MODEL: ${OLLAMA_LLM_MODEL:-llama3.2:1b}
      CHROMADB_PATH: /app/data/chromadb
      CHUNK_SIZE: ${CHUNK_SIZE:-500}
      CHUNK_OVERLAP: ${CHUNK_OVERLAP:-50}
      TOP_K_RESULTS: ${TOP_K_RESULTS:-5}
      LOG_LEVEL: ${PYTHON_LOG_LEVEL:-INFO}
    volumes:
      - ./rag-service/app:/app/app
      - rag_data:/app/data
    networks:
      - roads-authority-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ChromaDB (Optional - if running ChromaDB as separate service)
  # chromadb:
  #   image: chromadb/chroma:latest
  #   container_name: roads-authority-chromadb
  #   restart: unless-stopped
  #   ports:
  #     - "${CHROMADB_PORT:-8001}:8000"
  #   volumes:
  #     - chromadb_data:/chroma/chroma
  #   networks:
  #     - roads-authority-network
  #   environment:
  #     IS_PERSISTENT: TRUE
  #     ANONYMIZED_TELEMETRY: FALSE

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  rag_data:
    driver: local
  # chromadb_data:
  #   driver: local

networks:
  roads-authority-network:
    driver: bridge

# ==============================================
# USAGE INSTRUCTIONS
# ==============================================
#
# Start all services:
#   docker-compose up -d
#
# Start specific service:
#   docker-compose up -d mongodb redis
#
# View logs:
#   docker-compose logs -f
#   docker-compose logs -f backend
#
# Stop all services:
#   docker-compose down
#
# Stop and remove volumes:
#   docker-compose down -v
#
# Rebuild services:
#   docker-compose up -d --build
#
# ==============================================
# NOTES
# ==============================================
#
# 1. Ollama must be running on the host machine
#    Install: https://ollama.ai
#    Start: ollama serve
#    Pull models: 
#      ollama pull nomic-embed-text:latest
#      ollama pull llama3.2:1b
#
# 2. For production, use proper secrets management
#    and external database services
#
# 3. Update CLOUDINARY_* variables in .env
#    for file upload functionality
#
# 4. The mobile app (React Native) should be run
#    separately on your development machine
#
# 5. Health checks ensure services are ready
#    before dependent services start
#
# ==============================================
