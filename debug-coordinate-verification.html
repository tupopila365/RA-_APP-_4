<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Coordinate Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 120px;
        }
        #results {
            margin-top: 20px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Coordinate Verification Debug Tool</h1>
    
    <div class="test-section info">
        <h3>Manual Test</h3>
        <p>Enter coordinates to test the verification system:</p>
        <div>
            <label>Latitude: </label>
            <input type="number" id="latitude" value="-22.5609" step="any" placeholder="e.g., -22.5609">
            
            <label>Longitude: </label>
            <input type="number" id="longitude" value="17.0658" step="any" placeholder="e.g., 17.0658">
            
            <button onclick="testVerification()" id="verifyBtn">Verify Coordinates</button>
        </div>
    </div>

    <div class="test-section">
        <h3>Quick Tests</h3>
        <button onclick="testWindhoek()">Test Windhoek</button>
        <button onclick="testSwakopmund()">Test Swakopmund</button>
        <button onclick="testInvalid()">Test Invalid Location</button>
        <button onclick="testNetworkConnectivity()">Test Network</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="results">
        <h3>Results</h3>
        <div id="log" class="log">Ready to test...\n</div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.textContent = 'Log cleared...\n';
        }

        // Coordinate validation function (copied from the app)
        function validateCoordinates(latitude, longitude) {
            if (latitude === undefined || latitude === '' || longitude === undefined || longitude === '') {
                return { valid: false, error: 'Both latitude and longitude are required' };
            }

            const lat = typeof latitude === 'string' ? parseFloat(latitude) : latitude;
            const lon = typeof longitude === 'string' ? parseFloat(longitude) : longitude;

            if (isNaN(lat) || isNaN(lon)) {
                return { valid: false, error: 'Coordinates must be valid numbers' };
            }

            // Check Namibia bounds (with some buffer)
            if (lat < -30 || lat > -16 || lon < 10 || lon > 27) {
                return {
                    valid: false,
                    error: 'Coordinates are outside Namibia. Please verify the location.',
                };
            }

            return { valid: true };
        }

        // Reverse geocoding function (copied from the app)
        async function reverseGeocode(latitude, longitude) {
            try {
                log(`Starting reverse geocode for ${latitude}, ${longitude}`);
                
                const url = `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`;
                log(`Making request to: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'RoadsAuthority-Admin/1.0',
                    },
                });

                log(`Response status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    return {
                        success: false,
                        error: `HTTP ${response.status}: ${response.statusText}`,
                    };
                }

                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);

                if (data && data.display_name) {
                    return {
                        success: true,
                        latitude,
                        longitude,
                        displayName: data.display_name,
                    };
                }

                return {
                    success: false,
                    error: 'Location not found',
                };
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
                return {
                    success: false,
                    error: error.message || 'Reverse geocoding failed',
                };
            }
        }

        async function testVerification() {
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const verifyBtn = document.getElementById('verifyBtn');
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            
            log(`\n=== Testing Verification ===`);
            log(`Input coordinates: ${latitude}, ${longitude}`);

            // Step 1: Validate coordinates
            const validation = validateCoordinates(latitude, longitude);
            if (!validation.valid) {
                log(`Validation failed: ${validation.error}`, 'error');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Coordinates';
                return;
            }
            log('Coordinates passed validation', 'success');

            // Step 2: Reverse geocode
            const result = await reverseGeocode(latitude, longitude);
            
            if (result.success) {
                log(`Verification successful: ${result.displayName}`, 'success');
            } else {
                log(`Verification failed: ${result.error}`, 'error');
            }
            
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify Coordinates';
        }

        async function testWindhoek() {
            document.getElementById('latitude').value = -22.5609;
            document.getElementById('longitude').value = 17.0658;
            await testVerification();
        }

        async function testSwakopmund() {
            document.getElementById('latitude').value = -22.6792;
            document.getElementById('longitude').value = 14.5272;
            await testVerification();
        }

        async function testInvalid() {
            document.getElementById('latitude').value = -25.0000;
            document.getElementById('longitude').value = 10.0000;
            await testVerification();
        }

        async function testNetworkConnectivity() {
            log('\n=== Testing Network Connectivity ===');
            
            try {
                log('Testing basic connectivity...');
                const response = await fetch('https://httpbin.org/get', { 
                    method: 'HEAD',
                    mode: 'cors'
                });
                log(`Basic connectivity: ${response.status} ${response.statusText}`, 'success');
            } catch (error) {
                log(`Basic connectivity failed: ${error.message}`, 'error');
            }

            try {
                log('Testing Nominatim API availability...');
                const response = await fetch('https://nominatim.openstreetmap.org/status', {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'RoadsAuthority-Admin/1.0',
                    }
                });
                log(`Nominatim API: ${response.status} ${response.statusText}`, 'success');
            } catch (error) {
                log(`Nominatim API failed: ${error.message}`, 'error');
            }

            log(`Current protocol: ${window.location.protocol}`);
            log(`Current host: ${window.location.host}`);
        }

        // Auto-run network test on load
        window.addEventListener('load', () => {
            log('Debug tool loaded');
            testNetworkConnectivity();
        });
    </script>
</body>
</html>